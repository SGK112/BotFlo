<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Surprise Granite AI Chatbot</title>
  <style>
    body { font-family: 'Segoe UI', Arial, sans-serif; }
    #chatbot-float-btn {
      position: fixed; bottom: 24px; right: 24px; z-index: 9999;
      padding: 16px 30px; background: #2563eb; color: #fff; border: none;
      border-radius: 30px; font-size: 18px; cursor: pointer;
    }
    #chatbot-widget {
      display: none; position: fixed; bottom: 92px; right: 30px; z-index: 9999;
      width: 380px; max-width: 98vw;
      background: #fff; border-radius: 18px;
      box-shadow: 0 6px 32px rgba(0,0,0,0.21);
      flex-direction: column;
      overflow: hidden;
      font-family: 'Segoe UI', Arial, sans-serif;
    }
    #chatbot-header {
      background: #2563eb; color: #fff; padding: 0 16px; font-weight: bold; font-size: 18px;
      border-top-left-radius: 18px; border-top-right-radius: 18px;
      display: flex; align-items: center; justify-content: flex-start;
      height: 56px;
      border-bottom: 1px solid #2246a1;
      gap: 10px;
      position: relative;
    }
    #chatbot-logo {
      height: 35px; width: 35px; min-width: 35px; min-height: 35px;
      background: #fff; border-radius: 50%; object-fit: contain; border: 2px solid #fff;
      box-shadow: 0 2px 8px rgba(0,0,0,0.07);
      margin-right: 8px;
      display: block;
    }
    #chatbot-title { flex: 1; }
    #chatbot-close-btn {
      background: none; border: none; color: #fff; font-size: 28px; cursor: pointer; margin-left: auto;
    }
    #chatbot-info-btn {
      background: none; border: none; color: #e0e7ef; font-size: 22px; cursor: pointer;
      margin-left: 6px;
      transition: color 0.2s;
    }
    #chatbot-info-btn:hover {
      color: #fff;
    }
    #chatbot-body {
      padding: 16px;
      min-height: 170px;
      max-height: 320px;
      overflow-y: auto;
      background: #f6f7fb;
      font-size: 16px;
      line-height: 1.5;
      margin-bottom: 6px;
    }
    #chatbot-footer {
      display: flex; align-items: center;
      gap: 4px;
      padding: 0 10px 9px 10px;
      background: #fff;
      border-top: 1px solid #e5e7eb;
    }
    #chatbot-input {
      flex: 1;
      padding: 8px 12px;
      border-radius: 7px;
      border: 1px solid #c7d2fe;
      font-size: 16px;
      margin-right: 2px;
    }
    #chatbot-send-btn {
      background: #2563eb; color: #fff; border: none;
      border-radius: 7px;
      font-size: 16px; padding: 7px 16px;
      cursor: pointer;
      transition: background 0.2s;
    }
    #chatbot-send-btn:active {
      background: #1d4ed8;
    }
    #chatbot-attach-label {
      display: flex; align-items: center; cursor: pointer;
      margin-right: 6px; font-size: 22px; color: #2563eb;
      transition: color 0.2s;
    }
    #chatbot-attach-label:hover {
      color: #1d4ed8;
    }
    #chatbot-attach-input {
      display: none;
    }
    .chatbot-message {
      margin-bottom: 8px;
      padding: 8px 12px;
      border-radius: 10px;
      background: #e6eafe;
      color: #222;
      max-width: 85%;
      word-break: break-word;
      box-sizing: border-box;
    }
    .chatbot-message.user {
      background: #2563eb;
      color: #fff;
      margin-left: auto;
      text-align: right;
    }
    .chatbot-message.ai {
      background: #e6eafe;
      color: #222;
      margin-right: auto;
      text-align: left;
    }
    .chatbot-message img {
      max-width: 140px;
      max-height: 110px;
      display: block;
      border-radius: 8px;
      margin-top: 7px;
      margin-bottom: 2px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.10);
      background: #fff;
    }
    .chatbot-message .chatbot-attachment-name {
      font-size: 13px;
      color: #333;
      margin-top: 3px;
      word-break: break-all;
      background: #f0f0f8;
      border-radius: 4px;
      display: inline-block;
      padding: 1px 7px;
    }
    #chatbot-info-modal {
      display: none;
      position: fixed;
      z-index: 10001;
      left: 0; top: 0; width: 100vw; height: 100vh;
      background: rgba(30,32,48,0.29);
      justify-content: center;
      align-items: center;
    }
    #chatbot-info-modal-content {
      background: #fff;
      border-radius: 14px;
      padding: 28px 22px 18px 22px;
      box-shadow: 0 6px 42px rgba(0,0,0,0.09);
      max-width: 95vw;
      min-width: 260px;
      text-align: center;
      color: #252525;
      font-size: 16px;
      position: relative;
    }
    #chatbot-info-modal-close {
      position: absolute;
      top: 8px; right: 12px;
      font-size: 28px;
      background: none; border: none; color: #888; cursor: pointer;
    }
    #chatbot-info-modal strong { color: #2563eb; }
    #chatbot-info-modal a { color: #2463eb; text-decoration: none; }
    @media (max-width: 500px) {
      #chatbot-widget { width: 99vw; right: 0; border-radius: 0; }
      #chatbot-body { min-height: 120px; max-height: 34vh; }
      #chatbot-info-modal-content { min-width: 0; padding: 13vw 2vw; }
    }
  </style>
</head>
<body>
  <button id="chatbot-float-btn">ðŸ’¬ Chat with us</button>
  <div id="chatbot-widget">
    <div id="chatbot-header">
      <img id="chatbot-logo" src="https://cdn.prod.website-files.com/6456ce4476abb25581fbad0c/64a70d4b30e87feb388f004f_surprise-granite-profile-logo.svg" alt="Surprise Granite Logo" onerror="this.style.display='none';"/>
      <span id="chatbot-title">Surprise Granite AI</span>
      <button id="chatbot-info-btn" title="Business info">&#8505;</button>
      <button id="chatbot-close-btn" title="Close chat">&times;</button>
    </div>
    <div id="chatbot-body"></div>
    <form id="chatbot-footer" autocomplete="off">
      <label id="chatbot-attach-label" title="Attach image or file">
        <input id="chatbot-attach-input" type="file" accept="image/*,.pdf,.doc,.docx,.png,.jpg,.jpeg" multiple />
        &#128206;
      </label>
      <input id="chatbot-input" type="text" placeholder="Type your question..." autocomplete="off" />
      <button id="chatbot-send-btn" type="submit">Send</button>
    </form>
  </div>
  <!-- Info Modal -->
  <div id="chatbot-info-modal">
    <div id="chatbot-info-modal-content">
      <button id="chatbot-info-modal-close" title="Close info">&times;</button>
      <strong>Surprise Granite</strong><br>
      11560 N Dysart Rd. #112, Surprise, AZ 85379<br>
      <a href="tel:6028333189">(602) 833-3189</a><br>
      Mon-Fri: 8am-5pm &bull; Sat: 10am-2pm<br>
      <a href="https://www.surprisegranite.com" target="_blank">surprisegranite.com</a>
    </div>
  </div>
  <script>
    // Elements
    const floatBtn = document.getElementById("chatbot-float-btn");
    const widget = document.getElementById("chatbot-widget");
    const closeBtn = document.getElementById("chatbot-close-btn");
    const infoBtn = document.getElementById("chatbot-info-btn");
    const infoModal = document.getElementById("chatbot-info-modal");
    const infoModalClose = document.getElementById("chatbot-info-modal-close");
    const body = document.getElementById("chatbot-body");
    const form = document.getElementById("chatbot-footer");
    const input = document.getElementById("chatbot-input");
    const attachInput = document.getElementById("chatbot-attach-input");
    let attachedFiles = [];

    // Show widget
    floatBtn.onclick = function() {
      widget.style.display = "flex";
      floatBtn.style.display = "none";
      input.focus();
    };
    // Hide widget
    closeBtn.onclick = function() {
      widget.style.display = "none";
      floatBtn.style.display = "inline-block";
    };
    // Info modal
    infoBtn.onclick = function() {
      infoModal.style.display = "flex";
    };
    infoModalClose.onclick = function() {
      infoModal.style.display = "none";
    };
    infoModal.onclick = function(e) {
      if (e.target === infoModal) infoModal.style.display = "none";
    };

    // Helper to display a message or an image/file in chat
    function addMessage(content, sender, fileMeta) {
      const msg = document.createElement("div");
      msg.classList.add("chatbot-message", sender);

      if (fileMeta) {
        // If file is an image, show preview. Otherwise, show file name.
        if (fileMeta.type.startsWith("image/")) {
          const img = document.createElement("img");
          img.src = fileMeta.url;
          img.alt = fileMeta.name || "Attachment";
          msg.appendChild(img);
        }
        const nameSpan = document.createElement("div");
        nameSpan.className = "chatbot-attachment-name";
        nameSpan.textContent = fileMeta.name;
        msg.appendChild(nameSpan);
        if (content) {
          const captionDiv = document.createElement("div");
          captionDiv.textContent = content;
          msg.appendChild(captionDiv);
        }
      } else {
        msg.textContent = content;
      }
      body.appendChild(msg);
      body.scrollTop = body.scrollHeight;
    }

    // Handle file selection
    attachInput.onchange = function(event) {
      attachedFiles = Array.from(event.target.files);
      // Show previews in chat for user
      attachedFiles.forEach(file => {
        if (file.type.startsWith("image/")) {
          const reader = new FileReader();
          reader.onload = function(e) {
            addMessage("", "user", { url: e.target.result, name: file.name, type: file.type });
          };
          reader.readAsDataURL(file);
        } else {
          addMessage("", "user", { url: "", name: file.name, type: file.type });
        }
      });
    };

    // Send message and any attachments
    form.onsubmit = async function(e) {
      e.preventDefault();
      const text = input.value.trim();
      if (!text && attachedFiles.length === 0) return;
      if (text) addMessage(text, "user");
      addMessage("...", "ai");

      // Prepare form data for text and files
      const formData = new FormData();
      if (text) formData.append("message", text);
      attachedFiles.forEach(file => formData.append("attachments", file));

      // POST to backend
      try {
        const res = await fetch("/api/chat", {
          method: "POST",
          body: formData
        });
        const data = await res.json();
        // Remove loading
        const loading = body.querySelector(".chatbot-message.ai:last-child");
        if (loading && loading.textContent === "...") body.removeChild(loading);
        // Show AI response, handle attached files if any
        if (data.images && Array.isArray(data.images)) {
          data.images.forEach(imgUrl => {
            addMessage("", "ai", { url: imgUrl, name: "AI analysis", type: "image/png" });
          });
        }
        addMessage(data.message || "Sorry, something went wrong.", "ai");
      } catch (err) {
        const loading = body.querySelector(".chatbot-message.ai:last-child");
        if (loading && loading.textContent === "...") body.removeChild(loading);
        addMessage("Sorry, I couldn't reach the server.", "ai");
      }
      input.value = "";
      attachedFiles = [];
      attachInput.value = "";
    };
  </script>
</body>
</html>
