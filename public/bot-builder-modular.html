<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BotFlo.ai - Bot Builder</title>
    
    <!-- External Dependencies -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Bot Builder Styles -->
    <link href="/css/bot-builder/bot-builder.css" rel="stylesheet">
    
    <style>
        /* Additional page-specific styles can go here */
        .main-content {
            flex: 1;
            display: flex;
            transition: all 0.2s ease-in-out;
        }
        
        .main-content.sidebar-collapsed {
            margin-left: 0;
        }
        
        .main-content.preview-hidden .content-area {
            margin-right: 0;
        }
        
        .content-area {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .bot-preview {
            width: 400px;
            flex-shrink: 0;
            transition: all 0.2s ease-in-out;
        }
        
        .bot-preview.collapsed {
            width: 0;
            overflow: hidden;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="logo">
            <i class="fas fa-robot"></i>
            BotFlo.ai
        </div>
        
        <div class="bot-name" id="botName">My Chatbot</div>
        
        <div class="header-actions">
            <button class="btn btn-secondary" id="toggleSidebar" title="Toggle Sidebar">
                <i class="fas fa-chevron-left"></i>
            </button>
            <button class="btn btn-secondary" id="togglePreview" title="Toggle Preview">
                <i class="fas fa-eye"></i>
            </button>
            <button class="btn btn-primary" id="saveBot">
                <i class="fas fa-save"></i> Save
            </button>
            <button class="btn btn-success" id="deployBot">
                <i class="fas fa-rocket"></i> Deploy
            </button>
        </div>
    </header>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <!-- Bot Type Selection -->
            <div class="sidebar-section">
                <h3 class="sidebar-title">Bot Type</h3>
                <select class="form-select" id="botType">
                    <option value="customer-service">Customer Service</option>
                    <option value="lead-generation">Lead Generation</option>
                    <option value="sales">Sales Assistant</option>
                    <option value="support">Technical Support</option>
                    <option value="booking">Appointment Booking</option>
                    <option value="ecommerce">E-commerce</option>
                    <option value="custom">Custom Bot</option>
                </select>
            </div>

            <!-- Quick Actions -->
            <div class="sidebar-section">
                <h3 class="sidebar-title">Quick Edit</h3>
                <div class="quick-actions">
                    <div class="quick-action selected" data-section="basic">
                        <div class="quick-action-icon">
                            <i class="fas fa-cog"></i>
                        </div>
                        <div class="quick-action-title">Basic</div>
                    </div>
                    <div class="quick-action" data-section="messages">
                        <div class="quick-action-icon">
                            <i class="fas fa-comments"></i>
                        </div>
                        <div class="quick-action-title">Messages</div>
                    </div>
                    <div class="quick-action" data-section="actions">
                        <div class="quick-action-icon">
                            <i class="fas fa-bolt"></i>
                        </div>
                        <div class="quick-action-title">Actions</div>
                    </div>
                    <div class="quick-action" data-section="style">
                        <div class="quick-action-icon">
                            <i class="fas fa-palette"></i>
                        </div>
                        <div class="quick-action-title">Style</div>
                    </div>
                    <div class="quick-action" data-section="integrations">
                        <div class="quick-action-icon">
                            <i class="fas fa-plug"></i>
                        </div>
                        <div class="quick-action-title">Integrations</div>
                    </div>
                </div>
            </div>

            <!-- Template Actions -->
            <div class="sidebar-section">
                <h3 class="sidebar-title">Templates</h3>
                <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                    <button class="btn btn-secondary btn-small" onclick="window.botBuilder.modules.templates.showTemplateSelector()">
                        <i class="fas fa-folder-open"></i> Browse Templates
                    </button>
                    <button class="btn btn-secondary btn-small" onclick="window.botBuilder.modules.templates.createCustomTemplate()">
                        <i class="fas fa-plus"></i> Save as Template
                    </button>
                </div>
            </div>
        </aside>

        <!-- Main Content Area -->
        <main class="main-content">
            <div class="content-area">
                <!-- Tabs -->
                <nav class="tabs">
                    <button class="tab active" data-tab="properties">
                        <i class="fas fa-cog"></i> Properties
                    </button>
                    <button class="tab" data-tab="visual">
                        <i class="fas fa-project-diagram"></i> Visual Flow
                    </button>
                    <button class="tab" data-tab="settings">
                        <i class="fas fa-sliders-h"></i> Settings
                    </button>
                    <button class="tab" data-tab="deployment">
                        <i class="fas fa-rocket"></i> Deploy
                    </button>
                </nav>

                <!-- Tab Content -->
                <div class="tab-content active" id="properties-tab">
                    <div id="propertiesContent">
                        <!-- Properties content will be loaded here by the Properties module -->
                    </div>
                </div>

                <div class="tab-content" id="visual-tab">
                    <!-- Visual flow builder content will be loaded here by the Visual module -->
                </div>

                <div class="tab-content" id="settings-tab">
                    <div id="botSettings">
                        <!-- Settings content will be loaded here by the UI module -->
                    </div>
                </div>

                <div class="tab-content" id="deployment-tab">
                    <!-- Deployment content will be loaded here by the Deployment module -->
                </div>
            </div>

            <!-- Bot Preview -->
            <aside class="bot-preview" id="botPreview">
                <div class="preview-container">
                    <!-- Preview content will be loaded here by the Preview module -->
                </div>
            </aside>
        </main>
    </div>

    <!-- Bot Builder JavaScript Modules -->
    <script src="/js/bot-builder/bot-builder-api.js"></script>
    <script src="/js/bot-builder/bot-builder-ui.js"></script>
    <script src="/js/bot-builder/bot-builder-preview.js"></script>
    <script src="/js/bot-builder/bot-builder-properties.js"></script>
    <script src="/js/bot-builder/bot-builder-templates.js"></script>
    <script src="/js/bot-builder/bot-builder-visual.js"></script>
    <script src="/js/bot-builder/bot-builder-deployment.js"></script>
    <script src="/js/bot-builder/bot-builder-core.js"></script>

    <script>
        /**
         * Initialize Bot Builder Application
         */
        let botBuilder;

        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // Initialize the bot builder core
                botBuilder = new BotBuilderCore();
                
                // Make it globally available for easier debugging and module communication
                window.botBuilder = botBuilder;
                
                // Initialize the application
                await botBuilder.initialize();
                
                // Restore UI state from previous session
                if (botBuilder.modules.ui) {
                    botBuilder.modules.ui.restoreState();
                }
                
                console.log('ðŸŽ‰ BotFlo.ai Bot Builder initialized successfully!');
                
            } catch (error) {
                console.error('Failed to initialize Bot Builder:', error);
                
                // Show error notification if possible
                if (window.BotBuilderUI) {
                    const ui = new BotBuilderUI();
                    ui.showNotification('Failed to initialize Bot Builder: ' + error.message, 'error');
                } else {
                    alert('Failed to initialize Bot Builder. Please refresh the page and try again.');
                }
            }
        });

        /**
         * Handle page unload - save current state
         */
        window.addEventListener('beforeunload', function(e) {
            if (botBuilder && botBuilder.isInitialized) {
                // Trigger auto-save if there are unsaved changes
                const bot = botBuilder.getCurrentBot();
                if (bot.id) {
                    // Note: This is async but we can't wait for it in beforeunload
                    botBuilder.debouncedSave();
                }
            }
        });

        /**
         * Handle keyboard shortcuts globally
         */
        document.addEventListener('keydown', function(e) {
            // Don't interfere with form inputs
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                return;
            }

            // Help modal (F1 or ?)
            if (e.key === 'F1' || (e.shiftKey && e.key === '?')) {
                e.preventDefault();
                showHelpModal();
                return;
            }
        });

        /**
         * Show help modal with keyboard shortcuts and tips
         */
        function showHelpModal() {
            const modal = document.createElement('div');
            modal.className = 'modal help-modal active';
            modal.innerHTML = `
                <div class="modal-backdrop" onclick="this.parentElement.remove()"></div>
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>Bot Builder Help</h2>
                        <button class="modal-close" onclick="this.closest('.modal').remove()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-body">
                        <h3>Keyboard Shortcuts</h3>
                        <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 1rem; margin-bottom: 2rem;">
                            <div><kbd>Ctrl/Cmd + S</kbd></div><div>Save bot</div>
                            <div><kbd>Ctrl/Cmd + D</kbd></div><div>Deploy bot</div>
                            <div><kbd>Ctrl/Cmd + P</kbd></div><div>Toggle preview</div>
                            <div><kbd>Ctrl/Cmd + 1-4</kbd></div><div>Switch tabs</div>
                            <div><kbd>Esc</kbd></div><div>Close modals</div>
                            <div><kbd>F1 or ?</kbd></div><div>Show this help</div>
                        </div>
                        
                        <h3>Getting Started</h3>
                        <ol style="margin-left: 1.5rem; margin-bottom: 1.5rem;">
                            <li>Choose a bot type from the sidebar</li>
                            <li>Customize your bot using the Properties tab</li>
                            <li>Design conversation flows in the Visual tab</li>
                            <li>Configure integrations and settings</li>
                            <li>Test your bot using the preview panel</li>
                            <li>Deploy when ready</li>
                        </ol>
                        
                        <h3>Tips</h3>
                        <ul style="margin-left: 1.5rem;">
                            <li>Use templates to get started quickly</li>
                            <li>The preview panel shows real-time changes</li>
                            <li>Save your work as custom templates for reuse</li>
                            <li>Test thoroughly before deploying</li>
                        </ul>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-primary" onclick="this.closest('.modal').remove()">
                            Got it!
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        /**
         * Error handling for uncaught errors
         */
        window.addEventListener('error', function(e) {
            console.error('Uncaught error:', e.error);
            
            if (window.botBuilder && window.botBuilder.modules.ui) {
                window.botBuilder.modules.ui.showNotification(
                    'An unexpected error occurred. Please check the console for details.', 
                    'error'
                );
            }
        });

        /**
         * Handle unhandled promise rejections
         */
        window.addEventListener('unhandledrejection', function(e) {
            console.error('Unhandled promise rejection:', e.reason);
            
            if (window.botBuilder && window.botBuilder.modules.ui) {
                window.botBuilder.modules.ui.showNotification(
                    'An unexpected error occurred. Please check the console for details.', 
                    'error'
                );
            }
        });
    </script>
</body>
</html>
