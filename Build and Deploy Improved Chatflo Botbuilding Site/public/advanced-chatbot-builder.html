<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Chatbot Builder - ChatFlo</title>
    <link rel="stylesheet" href="/css/advanced-builder.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* Additional specific styles for this page */
        .builder-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .builder-header h1 {
            margin: 0;
            font-size: 28px;
            font-weight: 700;
        }
        
        .builder-header p {
            margin: 10px 0 0 0;
            opacity: 0.9;
            font-size: 16px;
        }
        
        .main-content {
            display: flex;
            height: calc(100vh - 100px);
        }
        
        .status-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #333;
            color: white;
            padding: 8px 20px;
            font-size: 12px;
            display: flex;
            justify-content: between;
            align-items: center;
            z-index: 1000;
        }
        
        .status-left {
            display: flex;
            gap: 20px;
        }
        
        .status-right {
            margin-left: auto;
        }
        
        .canvas-container {
            flex: 1;
            position: relative;
            background: #f8f9fa;
        }
        
        .canvas-overlay {
            position: absolute;
            top: 20px;
            left: 20px;
            background: white;
            padding: 10px 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            font-size: 14px;
            color: #666;
        }
        
        .help-tooltip {
            position: absolute;
            top: 20px;
            right: 20px;
            background: #2196F3;
            color: white;
            padding: 10px;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(33, 150, 243, 0.3);
            transition: all 0.3s ease;
        }
        
        .help-tooltip:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 20px rgba(33, 150, 243, 0.4);
        }
        
        .minimap {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 200px;
            height: 150px;
            background: white;
            border: 2px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .quick-actions {
            position: absolute;
            top: 80px;
            right: 20px;
            background: white;
            border-radius: 8px;
            padding: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .quick-action-btn {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background: white;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .quick-action-btn:hover {
            background: #f0f8ff;
            border-color: #2196F3;
            transform: translateY(-1px);
        }
    </style>
</head>
<body>
    <div class="builder-header">
        <h1><i class="fas fa-robot"></i> Advanced Chatbot Builder</h1>
        <p>Create sophisticated AI-powered chatbots with our visual flow builder</p>
    </div>

    <div class="main-content">
        <div class="builder-container">
            <!-- Toolbar will be inserted here by JavaScript -->
            
            <div class="canvas-container">
                <canvas id="chatbot-canvas"></canvas>
                
                <div class="canvas-overlay">
                    <strong>Canvas Controls:</strong><br>
                    • Drag to move nodes<br>
                    • Double-click to edit<br>
                    • Mouse wheel to zoom<br>
                    • Right-click for menu
                </div>
                
                <div class="help-tooltip" onclick="showHelp()">
                    <i class="fas fa-question"></i>
                </div>
                
                <div class="quick-actions">
                    <button class="quick-action-btn" onclick="quickSave()">
                        <i class="fas fa-save"></i> Quick Save
                    </button>
                    <button class="quick-action-btn" onclick="autoLayout()">
                        <i class="fas fa-sitemap"></i> Auto Layout
                    </button>
                    <button class="quick-action-btn" onclick="validateFlow()">
                        <i class="fas fa-check-circle"></i> Validate
                    </button>
                    <button class="quick-action-btn" onclick="shareFlow()">
                        <i class="fas fa-share"></i> Share
                    </button>
                </div>
                
                <div class="minimap" id="minimap-canvas-container">
                    <canvas id="minimap-canvas"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="status-bar">
        <div class="status-left">
            <span id="node-count">Nodes: 0</span>
            <span id="connection-count">Connections: 0</span>
            <span id="zoom-level">Zoom: 100%</span>
            <span id="last-saved">Last saved: Never</span>
        </div>
        <div class="status-right">
            <span id="cursor-position">Position: 0, 0</span>
        </div>
    </div>

    <!-- Progress Indicator -->
    <div class="progress-indicator" id="progress-indicator">
        <div class="progress-spinner"></div>
        <p id="progress-text">Processing...</p>
    </div>

    <!-- Load Scripts -->
    <script src="/js/chatbot-executor.js"></script>
    <script src="/js/advanced-chatbot-builder.js"></script>
    
    <script>
        // Additional helper functions for the interface
        let builderInstance = null;
        
        // Initialize builder when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            builderInstance = new AdvancedChatbotBuilder();
            setupStatusBar();
            setupKeyboardShortcuts();
        });

        function setupStatusBar() {
            const canvas = document.getElementById('chatbot-canvas');
            
            // Update cursor position
            canvas.addEventListener('mousemove', (e) => {
                const rect = canvas.getBoundingClientRect();
                const x = Math.round((e.clientX - rect.left - builderInstance.panX) / builderInstance.scale);
                const y = Math.round((e.clientY - rect.top - builderInstance.panY) / builderInstance.scale);
                document.getElementById('cursor-position').textContent = `Position: ${x}, ${y}`;
            });

            // Update status periodically
            setInterval(updateStatus, 1000);
        }

        function updateStatus() {
            if (!builderInstance) return;
            
            document.getElementById('node-count').textContent = `Nodes: ${builderInstance.nodes.size}`;
            document.getElementById('connection-count').textContent = `Connections: ${builderInstance.connections.length}`;
            document.getElementById('zoom-level').textContent = `Zoom: ${Math.round(builderInstance.scale * 100)}%`;
        }

        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', (e) => {
                // Global shortcuts
                if (e.ctrlKey || e.metaKey) {
                    switch(e.key) {
                        case 's':
                            e.preventDefault();
                            quickSave();
                            break;
                        case 'n':
                            e.preventDefault();
                            showNewChatbotDialog();
                            break;
                        case 'o':
                            e.preventDefault();
                            builderInstance.importChatbot();
                            break;
                        case 't':
                            e.preventDefault();
                            builderInstance.testChatbot();
                            break;
                    }
                }
            });
        }

        function showHelp() {
            const helpContent = `
                <h3>Chatbot Builder Help</h3>
                <h4>Getting Started:</h4>
                <ul>
                    <li>Drag node types from the left panel to create your flow</li>
                    <li>Double-click nodes to edit their properties</li>
                    <li>Connect nodes by dragging from output to input points</li>
                    <li>Use the Start node as your entry point</li>
                    <li>End with an End node or loop back to continue conversation</li>
                </ul>
                
                <h4>Node Types:</h4>
                <ul>
                    <li><strong>Message:</strong> Send a text message to the user</li>
                    <li><strong>Question:</strong> Ask for user input with validation</li>
                    <li><strong>Condition:</strong> Branch based on variables or user input</li>
                    <li><strong>API:</strong> Make external API calls</li>
                    <li><strong>AI:</strong> Generate responses using AI</li>
                    <li><strong>Delay:</strong> Add pauses for natural conversation flow</li>
                    <li><strong>Webhook:</strong> Send data to external services</li>
                </ul>
                
                <h4>Keyboard Shortcuts:</h4>
                <ul>
                    <li><kbd>Ctrl/Cmd + S</kbd> - Quick Save</li>
                    <li><kbd>Ctrl/Cmd + Z</kbd> - Undo</li>
                    <li><kbd>Ctrl/Cmd + Y</kbd> - Redo</li>
                    <li><kbd>Ctrl/Cmd + C</kbd> - Copy selected node</li>
                    <li><kbd>Ctrl/Cmd + V</kbd> - Paste copied node</li>
                    <li><kbd>Delete</kbd> - Delete selected node</li>
                    <li><kbd>Ctrl/Cmd + T</kbd> - Test chatbot</li>
                </ul>
                
                <h4>Variables:</h4>
                <p>Use {{variableName}} in messages to insert dynamic content. Variables are automatically created from user inputs in Question nodes.</p>
            `;
            
            showModal('Help - Advanced Chatbot Builder', helpContent);
        }

        function quickSave() {
            if (!builderInstance) return;
            
            showProgress('Saving chatbot...');
            
            const data = {
                nodes: Array.from(builderInstance.nodes.entries()),
                connections: builderInstance.connections,
                metadata: {
                    name: 'My Chatbot',
                    updated: new Date().toISOString()
                }
            };

            // Simulate save delay
            setTimeout(() => {
                localStorage.setItem('chatbot-builder-autosave', JSON.stringify(data));
                document.getElementById('last-saved').textContent = `Last saved: ${new Date().toLocaleTimeString()}`;
                hideProgress();
                showNotification('Chatbot saved successfully!', 'success');
            }, 1000);
        }

        function autoLayout() {
            if (!builderInstance) return;
            
            showProgress('Organizing layout...');
            
            setTimeout(() => {
                // Simple auto-layout algorithm
                const nodes = Array.from(builderInstance.nodes.values());
                const startNode = nodes.find(n => n.type === 'start');
                
                if (startNode) {
                    let currentY = 50;
                    const layerWidth = 200;
                    
                    // Organize nodes in layers
                    const visited = new Set();
                    const layers = [];
                    
                    function buildLayers(nodeId, layer = 0) {
                        if (visited.has(nodeId)) return;
                        visited.add(nodeId);
                        
                        if (!layers[layer]) layers[layer] = [];
                        layers[layer].push(nodeId);
                        
                        const connections = builderInstance.connections.filter(c => c.from.nodeId === nodeId);
                        connections.forEach(conn => {
                            buildLayers(conn.to.nodeId, layer + 1);
                        });
                    }
                    
                    buildLayers(startNode.id);
                    
                    // Position nodes
                    layers.forEach((layer, layerIndex) => {
                        layer.forEach((nodeId, nodeIndex) => {
                            const node = builderInstance.nodes.get(nodeId);
                            if (node) {
                                node.x = 50 + layerIndex * layerWidth;
                                node.y = 50 + nodeIndex * 120;
                            }
                        });
                    });
                    
                    builderInstance.saveState();
                    builderInstance.draw();
                }
                
                hideProgress();
                showNotification('Layout organized!', 'success');
            }, 1500);
        }

        function validateFlow() {
            if (!builderInstance) return;
            
            showProgress('Validating chatbot flow...');
            
            setTimeout(() => {
                const issues = [];
                
                // Check for start node
                const startNodes = Array.from(builderInstance.nodes.values()).filter(n => n.type === 'start');
                if (startNodes.length === 0) {
                    issues.push('No start node found');
                } else if (startNodes.length > 1) {
                    issues.push('Multiple start nodes found');
                }
                
                // Check for orphaned nodes
                const connectedNodes = new Set();
                builderInstance.connections.forEach(conn => {
                    connectedNodes.add(conn.from.nodeId);
                    connectedNodes.add(conn.to.nodeId);
                });
                
                const orphanedNodes = Array.from(builderInstance.nodes.keys()).filter(id => {
                    const node = builderInstance.nodes.get(id);
                    return node.type !== 'start' && !connectedNodes.has(id);
                });
                
                if (orphanedNodes.length > 0) {
                    issues.push(`${orphanedNodes.length} orphaned nodes found`);
                }
                
                // Check for empty message nodes
                const emptyMessages = Array.from(builderInstance.nodes.values()).filter(n => 
                    (n.type === 'message' || n.type === 'question') && !n.data.message?.trim()
                );
                
                if (emptyMessages.length > 0) {
                    issues.push(`${emptyMessages.length} nodes with empty messages`);
                }
                
                hideProgress();
                
                if (issues.length === 0) {
                    showNotification('✅ Chatbot flow is valid!', 'success');
                } else {
                    const issueList = issues.map(issue => `• ${issue}`).join('<br>');
                    showModal('Validation Issues', `<p>Found ${issues.length} issues:</p><br>${issueList}`);
                }
            }, 1000);
        }

        function shareFlow() {
            if (!builderInstance) return;
            
            const data = {
                nodes: Array.from(builderInstance.nodes.entries()),
                connections: builderInstance.connections
            };
            
            const shareUrl = `${window.location.origin}/shared/${btoa(JSON.stringify(data))}`;
            
            if (navigator.share) {
                navigator.share({
                    title: 'My Chatbot Flow',
                    text: 'Check out this chatbot I created!',
                    url: shareUrl
                });
            } else {
                navigator.clipboard.writeText(shareUrl).then(() => {
                    showNotification('Share URL copied to clipboard!', 'success');
                }).catch(() => {
                    showModal('Share Chatbot', `<p>Copy this URL to share your chatbot:</p><br><input type="text" value="${shareUrl}" style="width: 100%; padding: 10px;" readonly onclick="this.select()">`);
                });
            }
        }

        function showProgress(text) {
            const indicator = document.getElementById('progress-indicator');
            const textEl = document.getElementById('progress-text');
            textEl.textContent = text;
            indicator.style.display = 'block';
        }

        function hideProgress() {
            document.getElementById('progress-indicator').style.display = 'none';
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? '#4CAF50' : type === 'error' ? '#f44336' : '#2196F3'};
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 20px rgba(0,0,0,0.3);
                z-index: 2000;
                animation: slideInRight 0.3s ease;
                max-width: 300px;
                font-weight: 500;
            `;
            
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => document.body.removeChild(notification), 300);
            }, 3000);
        }

        function showModal(title, content) {
            const modal = document.createElement('div');
            modal.className = 'node-edit-modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>${title}</h3>
                        <button class="close-btn">&times;</button>
                    </div>
                    <div class="modal-body">
                        ${content}
                    </div>
                    <div class="modal-footer">
                        <button class="btn-secondary" onclick="this.closest('.node-edit-modal').remove()">Close</button>
                    </div>
                </div>
            `;
            
            modal.querySelector('.close-btn').onclick = () => modal.remove();
            modal.onclick = (e) => {
                if (e.target === modal) modal.remove();
            };
            
            document.body.appendChild(modal);
        }

        // Add CSS animations
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideInRight {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOutRight {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>
