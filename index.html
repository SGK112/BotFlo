<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CARI - Countertop Analysis App</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: Arial, sans-serif;
    }

    body {
      min-height: 100vh;
      background-color: #f0f0f0;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
    }

    h1 {
      font-size: 2.5rem;
      color: #333;
      margin-bottom: 20px;
    }

    .upload-area {
      width: 100%;
      max-width: 400px;
      padding: 20px;
      border: 2px dashed #666;
      border-radius: 8px;
      text-align: center;
      background-color: #fff;
      cursor: pointer;
      transition: border-color 0.3s, background-color 0.3s;
    }

    .upload-area.drag-active {
      border-color: #007bff;
      background-color: #e6f0ff;
    }

    .upload-area p {
      color: #666;
      font-size: 1rem;
    }

    .preview-image {
      max-width: 100%;
      max-height: 200px;
      margin-top: 10px;
      object-fit: contain;
    }

    .buttons {
      margin-top: 15px;
      display: flex;
      gap: 10px;
    }

    button {
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      font-size: 1rem;
      font-weight: bold;
      cursor: pointer;
      transition: background-color 0.3s;
    }

    #analyze-btn {
      background-color: #007bff;
      color: #fff;
    }

    #analyze-btn:disabled {
      background-color: #999;
      cursor: not-allowed;
    }

    #analyze-btn:not(:disabled):hover {
      background-color: #0056b3;
    }

    #reset-btn {
      background-color: #ccc;
      color: #333;
    }

    #reset-btn:hover {
      background-color: #b3b3b3;
    }

    .error {
      margin-top: 15px;
      padding: 10px;
      background-color: #ffe6e6;
      color: #cc0000;
      border-radius: 5px;
      max-width: 400px;
      width: 100%;
    }

    .results {
      margin-top: 20px;
      padding: 20px;
      background-color: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      max-width: 400px;
      width: 100%;
    }

    .results h2 {
      font-size: 1.5rem;
      color: #333;
      margin-bottom: 15px;
    }

    .results p {
      margin-bottom: 8px;
      font-size: 1rem;
      color: #555;
    }

    .results p span {
      font-weight: bold;
      color: #333;
    }

    .results audio {
      width: 100%;
      margin-top: 10px;
    }

    footer {
      margin-top: 30px;
      font-size: 0.9rem;
      color: #666;
    }
  </style>
</head>
<body>
  <h1>CARI - Countertop Analysis</h1>

  <!-- Image Upload Section -->
  <div id="upload-area" class="upload-area">
    <input type="file" id="file-input" accept="image/*" style="display: none;" />
    <p id="upload-text">Drag & drop a countertop image here, or click to select one</p>
    <img id="preview-image" class="preview-image" style="display: none;" alt="Uploaded countertop" />
  </div>

  <!-- Action Buttons -->
  <div class="buttons">
    <button id="analyze-btn" disabled>Analyze Countertop</button>
    <button id="reset-btn">Reset</button>
  </div>

  <!-- Error Message -->
  <div id="error-message" class="error" style="display: none;"></div>

  <!-- Analysis Results -->
  <div id="results" class="results" style="display: none;">
    <h2>Analysis Results</h2>
    <p><span>Stone Type:</span> <span id="stone-type"></span></p>
    <p><span>Color & Pattern:</span> <span id="color-pattern"></span></p>
    <p><span>Natural Stone:</span> <span id="is-natural-stone"></span></p>
    <p><span>Damage Type:</span> <span id="damage-type"></span></p>
    <p><span>Severity:</span> <span id="severity"></span></p>
    <p><span>Estimated Cost:</span> <span id="estimated-cost"></span></p>
    <p><span>Recommendation:</span> <span id="recommendation"></span></p>
    <p><span>Description:</span> <span id="description"></span></p>
    <p id="matched-color" style="display: none;">
      <span>Matched Color:</span> <span id="matched-color-value"></span>
    </p>
    <div id="audio-section" style="display: none;">
      <h3>Audio Narration</h3>
      <audio id="audio-player" controls aria-label="Audio narration of analysis results"></audio>
    </div>
  </div>

  <!-- Footer -->
  <footer>Powered by Surprise Granite Â© 2025</footer>

  <script>
    const BASE_URL = "https://surprise-granite-connections-dev.onrender.com";

    // DOM Elements
    const uploadArea = document.getElementById("upload-area");
    const fileInput = document.getElementById("file-input");
    const uploadText = document.getElementById("upload-text");
    const previewImage = document.getElementById("preview-image");
    const analyzeBtn = document.getElementById("analyze-btn");
    const resetBtn = document.getElementById("reset-btn");
    const errorMessage = document.getElementById("error-message");
    const results = document.getElementById("results");
    const audioSection = document.getElementById("audio-section");
    const audioPlayer = document.getElementById("audio-player");

    let imageFile = null;

    // Drag-and-Drop Functionality
    uploadArea.addEventListener("dragover", (e) => {
      e.preventDefault();
      uploadArea.classList.add("drag-active");
    });

    uploadArea.addEventListener("dragleave", (e) => {
      e.preventDefault();
      uploadArea.classList.remove("drag-active");
    });

    uploadArea.addEventListener("drop", (e) => {
      e.preventDefault();
      uploadArea.classList.remove("drag-active");
      const file = e.dataTransfer.files[0];
      handleFile(file);
    });

    uploadArea.addEventListener("click", () => {
      fileInput.click();
    });

    fileInput.addEventListener("change", (e) => {
      const file = e.target.files[0];
      handleFile(file);
    });

    function handleFile(file) {
      if (file && file.type.startsWith("image/")) {
        if (file.size > 5 * 1024 * 1024) {
          showError("Image size exceeds 5MB limit.");
          return;
        }
        imageFile = file;
        const url = URL.createObjectURL(file);
        previewImage.src = url;
        previewImage.style.display = "block";
        uploadText.textContent = file.name;
        analyzeBtn.disabled = false;
        clearResults();
        clearError();
      } else {
        showError("Please upload a valid image file.");
      }
    }

    // Analyze Button
    analyzeBtn.addEventListener("click", async () => {
      if (!imageFile) {
        showError("Please upload an image first.");
        return;
      }

      analyzeBtn.disabled = true;
      analyzeBtn.textContent = "Analyzing...";
      clearError();
      clearResults();

      try {
        // Upload image to /api/upload-image
        const formData = new FormData();
        formData.append("file", imageFile);

        const analysisResponse = await fetch(`${BASE_URL}/api/upload-image`, {
          method: "POST",
          body: formData,
        });

        if (!analysisResponse.ok) {
          const errorData = await analysisResponse.json();
          throw new Error(errorData.error || "Failed to analyze the image.");
        }

        const { response: result } = await analysisResponse.json();
        displayResults(result);

        // Generate audio narration
        const narrationText = `
          The countertop is made of ${result.stoneType} with a ${result.colorPattern} pattern.
          It is ${result.isNaturalStone ? "a natural stone" : "not a natural stone"}.
          The detected damage is ${result.damageType || "none"}, with a severity of ${result.severity || "none"}.
          The estimated repair cost is ${result.estimatedCost}.
          Recommendation: ${result.recommendation}.
          ${result.description}
        `;

        const audioResponse = await fetch(`${BASE_URL}/api/speak`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ text: narrationText, voice: "shimmer", speed: 1.0 }),
        });

        if (!audioResponse.ok) {
          const errorData = await audioResponse.json();
          throw new Error(errorData.error || "Failed to generate audio narration.");
        }

        const audioBlob = await audioResponse.blob();
        const audioUrl = URL.createObjectURL(audioBlob);
        audioPlayer.src = audioUrl;
        audioSection.style.display = "block";
      } catch (err) {
        showError(err.message);
      } finally {
        analyzeBtn.disabled = false;
        analyzeBtn.textContent = "Analyze Countertop";
      }
    });

    // Reset Button
    resetBtn.addEventListener("click", () => {
      imageFile = null;
      fileInput.value = "";
      uploadText.textContent = "Drag & drop a countertop image here, or click to select one";
      previewImage.style.display = "none";
      previewImage.src = "";
      analyzeBtn.disabled = true;
      clearResults();
      clearError();
    });

    // Helper Functions
    function showError(message) {
      errorMessage.textContent = message;
      errorMessage.style.display = "block";
    }

    function clearError() {
      errorMessage.textContent = "";
      errorMessage.style.display = "none";
    }

    function displayResults(result) {
      document.getElementById("stone-type").textContent = result.stoneType;
      document.getElementById("color-pattern").textContent = result.colorPattern;
      document.getElementById("is-natural-stone").textContent = result.isNaturalStone ? "Yes" : "No";
      document.getElementById("damage-type").textContent = result.damageType || "None";
      document.getElementById("severity").textContent = result.severity || "None";
      document.getElementById("estimated-cost").textContent = result.estimatedCost;
      document.getElementById("recommendation").textContent = result.recommendation;
      document.getElementById("description").textContent = result.description;

      const matchedColor = document.getElementById("matched-color");
      if (result.matchedColor) {
        document.getElementById("matched-color-value").textContent = `${result.matchedColor} (${result.matchedVendor})`;
        matchedColor.style.display = "block";
      } else {
        matchedColor.style.display = "none";
      }

      results.style.display = "block";
    }

    function clearResults() {
      results.style.display = "none";
      audioSection.style.display = "none";
      audioPlayer.src = "";
    }
  </script>
</body>
</html>
