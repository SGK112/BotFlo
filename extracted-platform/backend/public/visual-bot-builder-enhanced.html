<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visual Bot Builder - BotFlo</title>
    <meta name="description" content="Drag-and-drop visual bot builder with advanced flow control and real-time collaboration.">
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="alternate icon" href="/favicon.ico">
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <style>
        /* Modern CSS Custom Properties */
        :root {
            /* Brand Colors */
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --primary-light: #818cf8;
            --secondary: #06b6d4;
            --accent: #f59e0b;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            
            /* Neutral Colors */
            --white: #ffffff;
            --gray-50: #f8fafc;
            --gray-100: #f1f5f9;
            --gray-200: #e2e8f0;
            --gray-300: #cbd5e1;
            --gray-400: #94a3b8;
            --gray-500: #64748b;
            --gray-600: #475569;
            --gray-700: #334155;
            --gray-800: #1e293b;
            --gray-900: #0f172a;
            
            /* Spacing */
            --spacing-xs: 0.25rem;
            --spacing-sm: 0.5rem;
            --spacing-md: 1rem;
            --spacing-lg: 1.5rem;
            --spacing-xl: 2rem;
            --spacing-2xl: 3rem;
            --spacing-3xl: 4rem;
            
            /* Border Radius */
            --radius-sm: 0.375rem;
            --radius-md: 0.5rem;
            --radius-lg: 0.75rem;
            --radius-xl: 1rem;
            --radius-2xl: 1.5rem;
            
            /* Shadows */
            --shadow-xs: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-sm: 0 1px 3px 0 rgb(0 0 0 / 0.1);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1);
            
            /* Transitions */
            --transition-fast: 150ms ease-in-out;
            --transition-base: 250ms ease-in-out;
        }

        /* Reset & Base Styles */
        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--gray-50);
            color: var(--gray-900);
            overflow-x: hidden;
        }

        /* App Layout */
        .app {
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Top Navigation Bar */
        .top-nav {
            background: var(--white);
            border-bottom: 1px solid var(--gray-200);
            padding: 0 var(--spacing-lg);
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: var(--shadow-sm);
            z-index: 1000;
        }

        .nav-left {
            display: flex;
            align-items: center;
            gap: var(--spacing-lg);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            font-size: 1.25rem;
            font-weight: 800;
            color: var(--primary);
            text-decoration: none;
        }

        .project-info {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
        }

        .project-name {
            font-weight: 600;
            color: var(--gray-900);
        }

        .project-status {
            padding: 0.25rem 0.75rem;
            background: var(--success);
            color: var(--white);
            border-radius: var(--radius-md);
            font-size: 0.75rem;
            font-weight: 600;
        }

        .nav-center {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
        }

        .nav-btn {
            padding: 0.5rem 1rem;
            border: 1px solid var(--gray-300);
            background: var(--white);
            color: var(--gray-700);
            border-radius: var(--radius-md);
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition-fast);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .nav-btn:hover {
            background: var(--gray-50);
            border-color: var(--primary);
        }

        .nav-btn.primary {
            background: var(--primary);
            color: var(--white);
            border-color: var(--primary);
        }

        .nav-btn.primary:hover {
            background: var(--primary-dark);
        }

        .nav-right {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--primary);
            color: var(--white);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.875rem;
        }

        /* Main Content Area */
        .main-content {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background: var(--white);
            border-right: 1px solid var(--gray-200);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .sidebar-header {
            padding: var(--spacing-lg);
            border-bottom: 1px solid var(--gray-200);
        }

        .sidebar-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--gray-900);
            margin-bottom: var(--spacing-sm);
        }

        .search-box {
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 0.5rem 0.75rem 0.5rem 2.5rem;
            border: 1px solid var(--gray-300);
            border-radius: var(--radius-md);
            font-size: 0.875rem;
            outline: none;
            transition: border-color var(--transition-fast);
        }

        .search-input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgb(99 102 241 / 0.1);
        }

        .search-icon {
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray-400);
            font-size: 0.875rem;
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: var(--spacing-lg);
        }

        .node-category {
            margin-bottom: var(--spacing-xl);
        }

        .category-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--gray-700);
            margin-bottom: var(--spacing-md);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .node-list {
            display: grid;
            gap: var(--spacing-sm);
        }

        .node-item {
            padding: var(--spacing-md);
            background: var(--gray-50);
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-lg);
            cursor: grab;
            transition: all var(--transition-fast);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .node-item:hover {
            background: var(--primary);
            color: var(--white);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .node-item:active {
            cursor: grabbing;
        }

        .node-icon {
            width: 20px;
            text-align: center;
        }

        .node-name {
            font-size: 0.875rem;
            font-weight: 500;
        }

        /* Canvas Area */
        .canvas-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .canvas-toolbar {
            background: var(--white);
            border-bottom: 1px solid var(--gray-200);
            padding: var(--spacing-md) var(--spacing-lg);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .toolbar-left {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
        }

        .zoom-controls {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            padding: 0.25rem;
            background: var(--gray-100);
            border-radius: var(--radius-md);
        }

        .zoom-btn {
            width: 32px;
            height: 32px;
            border: none;
            background: transparent;
            color: var(--gray-600);
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all var(--transition-fast);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .zoom-btn:hover {
            background: var(--white);
            color: var(--gray-900);
        }

        .zoom-level {
            padding: 0 var(--spacing-sm);
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--gray-700);
            min-width: 50px;
            text-align: center;
        }

        .canvas {
            flex: 1;
            position: relative;
            background: 
                radial-gradient(circle, var(--gray-300) 1px, transparent 1px);
            background-size: 20px 20px;
            background-position: 0 0, 10px 10px;
            overflow: hidden;
            cursor: grab;
        }

        .canvas:active {
            cursor: grabbing;
        }

        .canvas-content {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            transform-origin: 0 0;
        }

        /* Flow Nodes */
        .flow-node {
            position: absolute;
            min-width: 200px;
            background: var(--white);
            border: 2px solid var(--gray-300);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-lg);
            cursor: move;
            transition: all var(--transition-fast);
        }

        .flow-node:hover {
            border-color: var(--primary);
            box-shadow: var(--shadow-xl);
        }

        .flow-node.selected {
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgb(99 102 241 / 0.2);
        }

        .node-header {
            padding: var(--spacing-md) var(--spacing-lg);
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            background: var(--gray-50);
            border-radius: var(--radius-xl) var(--radius-xl) 0 0;
        }

        .node-type-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            color: var(--white);
        }

        .node-type-icon.start { background: var(--success); }
        .node-type-icon.message { background: var(--primary); }
        .node-type-icon.condition { background: var(--warning); }
        .node-type-icon.action { background: var(--secondary); }
        .node-type-icon.end { background: var(--error); }

        .node-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--gray-900);
        }

        .node-body {
            padding: var(--spacing-lg);
        }

        .node-input, .node-textarea {
            width: 100%;
            padding: var(--spacing-sm) var(--spacing-md);
            border: 1px solid var(--gray-300);
            border-radius: var(--radius-md);
            font-size: 0.875rem;
            outline: none;
            transition: border-color var(--transition-fast);
            margin-bottom: var(--spacing-md);
        }

        .node-input:focus, .node-textarea:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgb(99 102 241 / 0.1);
        }

        .node-textarea {
            resize: vertical;
            min-height: 80px;
        }

        /* Connection Points */
        .connection-point {
            position: absolute;
            width: 12px;
            height: 12px;
            background: var(--primary);
            border: 2px solid var(--white);
            border-radius: 50%;
            cursor: crosshair;
            transition: all var(--transition-fast);
        }

        .connection-point:hover {
            transform: scale(1.2);
            box-shadow: 0 0 0 4px rgb(99 102 241 / 0.3);
        }

        .connection-point.input {
            left: -6px;
            top: 50%;
            transform: translateY(-50%);
        }

        .connection-point.output {
            right: -6px;
            top: 50%;
            transform: translateY(-50%);
        }

        /* Properties Panel */
        .properties-panel {
            width: 320px;
            background: var(--white);
            border-left: 1px solid var(--gray-200);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .properties-header {
            padding: var(--spacing-lg);
            border-bottom: 1px solid var(--gray-200);
        }

        .properties-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--gray-900);
        }

        .properties-content {
            flex: 1;
            padding: var(--spacing-lg);
            overflow-y: auto;
        }

        .property-group {
            margin-bottom: var(--spacing-xl);
        }

        .property-label {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--gray-700);
            margin-bottom: var(--spacing-sm);
        }

        .property-input {
            width: 100%;
            padding: var(--spacing-sm) var(--spacing-md);
            border: 1px solid var(--gray-300);
            border-radius: var(--radius-md);
            font-size: 0.875rem;
            outline: none;
            transition: border-color var(--transition-fast);
        }

        .property-input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgb(99 102 241 / 0.1);
        }

        /* Bottom Status Bar */
        .status-bar {
            background: var(--gray-100);
            border-top: 1px solid var(--gray-200);
            padding: var(--spacing-sm) var(--spacing-lg);
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 0.75rem;
            color: var(--gray-600);
        }

        .status-left {
            display: flex;
            align-items: center;
            gap: var(--spacing-lg);
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .sidebar {
                width: 240px;
            }
            
            .properties-panel {
                width: 280px;
            }
        }

        @media (max-width: 768px) {
            .sidebar, .properties-panel {
                position: fixed;
                top: 60px;
                bottom: 0;
                z-index: 100;
                transform: translateX(-100%);
                transition: transform var(--transition-base);
            }

            .sidebar.open, .properties-panel.open {
                transform: translateX(0);
            }

            .properties-panel {
                right: 0;
                transform: translateX(100%);
            }

            .nav-center {
                display: none;
            }

            .project-info {
                display: none;
            }
        }

        /* Animations */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .flow-node {
            animation: fadeIn 0.3s ease-out;
        }

        /* Context Menu */
        .context-menu {
            position: fixed;
            background: var(--white);
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-xl);
            padding: var(--spacing-sm);
            z-index: 1000;
            display: none;
        }

        .context-menu-item {
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--radius-md);
            cursor: pointer;
            font-size: 0.875rem;
            transition: background var(--transition-fast);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .context-menu-item:hover {
            background: var(--gray-100);
        }

        .context-menu-separator {
            height: 1px;
            background: var(--gray-200);
            margin: var(--spacing-sm) 0;
        }
    </style>
</head>
<body>
    <div class="app">
        <!-- Top Navigation -->
        <nav class="top-nav">
            <div class="nav-left">
                <a href="/" class="logo">
                    <i class="fas fa-robot"></i>
                    BotFlo
                </a>
                <a href="/builders" class="nav-btn" style="margin-left: var(--spacing-md);">
                    <i class="fas fa-arrow-left"></i>
                    Back to Builders
                </a>
                <div class="project-info">
                    <span class="project-name">My Chatbot</span>
                    <span class="project-status">
                        <i class="fas fa-circle" style="font-size: 0.5rem;"></i>
                        Live
                    </span>
                </div>
            </div>

            <div class="nav-center">
                <button class="nav-btn">
                    <i class="fas fa-play"></i>
                    Test Bot
                </button>
                <button class="nav-btn">
                    <i class="fas fa-download"></i>
                    Export
                </button>
                <button class="nav-btn primary">
                    <i class="fas fa-save"></i>
                    Save
                </button>
            </div>

            <div class="nav-right">
                <button class="nav-btn" id="sidebarToggle">
                    <i class="fas fa-bars"></i>
                </button>
                <button class="nav-btn" id="propertiesToggle">
                    <i class="fas fa-cog"></i>
                </button>
                <div class="user-avatar">JD</div>
            </div>
        </nav>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Sidebar -->
            <div class="sidebar" id="sidebar">
                <div class="sidebar-header">
                    <h2 class="sidebar-title">Components</h2>
                    <div class="search-box">
                        <input type="text" class="search-input" placeholder="Search components...">
                        <i class="fas fa-search search-icon"></i>
                    </div>
                </div>
                <div class="sidebar-content">
                    <div class="node-category">
                        <h3 class="category-title">Basic</h3>
                        <div class="node-list">
                            <div class="node-item" data-node-type="start">
                                <i class="fas fa-play node-icon"></i>
                                <span class="node-name">Start</span>
                            </div>
                            <div class="node-item" data-node-type="message">
                                <i class="fas fa-comment node-icon"></i>
                                <span class="node-name">Message</span>
                            </div>
                            <div class="node-item" data-node-type="input">
                                <i class="fas fa-keyboard node-icon"></i>
                                <span class="node-name">User Input</span>
                            </div>
                            <div class="node-item" data-node-type="condition">
                                <i class="fas fa-code-branch node-icon"></i>
                                <span class="node-name">Condition</span>
                            </div>
                        </div>
                    </div>

                    <div class="node-category">
                        <h3 class="category-title">Actions</h3>
                        <div class="node-list">
                            <div class="node-item" data-node-type="api">
                                <i class="fas fa-cloud node-icon"></i>
                                <span class="node-name">API Call</span>
                            </div>
                            <div class="node-item" data-node-type="webhook">
                                <i class="fas fa-link node-icon"></i>
                                <span class="node-name">Webhook</span>
                            </div>
                            <div class="node-item" data-node-type="delay">
                                <i class="fas fa-clock node-icon"></i>
                                <span class="node-name">Delay</span>
                            </div>
                            <div class="node-item" data-node-type="redirect">
                                <i class="fas fa-external-link-alt node-icon"></i>
                                <span class="node-name">Redirect</span>
                            </div>
                        </div>
                    </div>

                    <div class="node-category">
                        <h3 class="category-title">Integration</h3>
                        <div class="node-list">
                            <div class="node-item" data-node-type="email">
                                <i class="fas fa-envelope node-icon"></i>
                                <span class="node-name">Send Email</span>
                            </div>
                            <div class="node-item" data-node-type="database">
                                <i class="fas fa-database node-icon"></i>
                                <span class="node-name">Database</span>
                            </div>
                            <div class="node-item" data-node-type="analytics">
                                <i class="fas fa-chart-bar node-icon"></i>
                                <span class="node-name">Analytics</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Canvas -->
            <div class="canvas-container">
                <div class="canvas-toolbar">
                    <div class="toolbar-left">
                        <div class="zoom-controls">
                            <button class="zoom-btn" id="zoomOut">
                                <i class="fas fa-minus"></i>
                            </button>
                            <span class="zoom-level" id="zoomLevel">100%</span>
                            <button class="zoom-btn" id="zoomIn">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                        <button class="nav-btn" id="fitToScreen">
                            <i class="fas fa-expand-arrows-alt"></i>
                            Fit to Screen
                        </button>
                    </div>
                    <div class="toolbar-right">
                        <button class="nav-btn">
                            <i class="fas fa-undo"></i>
                            Undo
                        </button>
                        <button class="nav-btn">
                            <i class="fas fa-redo"></i>
                            Redo
                        </button>
                    </div>
                </div>

                <div class="canvas" id="canvas">
                    <div class="canvas-content" id="canvasContent">
                        <!-- Start Node (Default) -->
                        <div class="flow-node selected" style="top: 100px; left: 200px;" data-node-id="start-1">
                            <div class="connection-point output"></div>
                            <div class="node-header">
                                <div class="node-type-icon start">
                                    <i class="fas fa-play"></i>
                                </div>
                                <div class="node-title">Bot Started</div>
                            </div>
                            <div class="node-body">
                                <p style="font-size: 0.875rem; color: var(--gray-600); margin: 0;">
                                    This is where your bot conversation begins.
                                </p>
                            </div>
                        </div>

                        <!-- Welcome Message Node -->
                        <div class="flow-node" style="top: 250px; left: 200px;" data-node-id="message-1">
                            <div class="connection-point input"></div>
                            <div class="connection-point output"></div>
                            <div class="node-header">
                                <div class="node-type-icon message">
                                    <i class="fas fa-comment"></i>
                                </div>
                                <div class="node-title">Welcome Message</div>
                            </div>
                            <div class="node-body">
                                <textarea class="node-textarea" placeholder="Enter your message...">👋 Hello! Welcome to our chatbot. How can I help you today?</textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Properties Panel -->
            <div class="properties-panel" id="propertiesPanel">
                <div class="properties-header">
                    <h2 class="properties-title">Properties</h2>
                </div>
                <div class="properties-content">
                    <div class="property-group">
                        <label class="property-label">Node ID</label>
                        <input type="text" class="property-input" value="start-1" readonly>
                    </div>
                    <div class="property-group">
                        <label class="property-label">Node Type</label>
                        <input type="text" class="property-input" value="Start Node" readonly>
                    </div>
                    <div class="property-group">
                        <label class="property-label">Description</label>
                        <textarea class="property-input" style="height: 80px;" placeholder="Add a description...">Entry point for the chatbot conversation.</textarea>
                    </div>
                    <div class="property-group">
                        <label class="property-label">Next Action</label>
                        <select class="property-input">
                            <option value="auto">Automatic</option>
                            <option value="condition">Wait for condition</option>
                            <option value="manual">Manual trigger</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- Status Bar -->
        <div class="status-bar">
            <div class="status-left">
                <div class="status-item">
                    <i class="fas fa-project-diagram"></i>
                    <span>2 nodes connected</span>
                </div>
                <div class="status-item">
                    <i class="fas fa-save"></i>
                    <span>Auto-saved 2 min ago</span>
                </div>
            </div>
            <div class="status-right">
                <div class="status-item">
                    <i class="fas fa-users"></i>
                    <span>1 collaborator online</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Context Menu -->
    <div class="context-menu" id="contextMenu">
        <div class="context-menu-item" data-action="copy">
            <i class="fas fa-copy"></i>
            Copy
        </div>
        <div class="context-menu-item" data-action="paste">
            <i class="fas fa-paste"></i>
            Paste
        </div>
        <div class="context-menu-separator"></div>
        <div class="context-menu-item" data-action="delete">
            <i class="fas fa-trash"></i>
            Delete
        </div>
    </div>

    <script>
        // Visual Bot Builder JavaScript
        class VisualBotBuilder {
            constructor() {
                this.canvas = document.getElementById('canvas');
                this.canvasContent = document.getElementById('canvasContent');
                this.zoom = 1;
                this.selectedNode = null;
                this.isDragging = false;
                this.dragOffset = { x: 0, y: 0 };
                this.nodes = new Map();
                this.connections = new Map();
                
                this.init();
            }

            init() {
                this.setupEventListeners();
                this.loadExistingNodes();
                this.setupDragAndDrop();
                this.setupZoomControls();
                this.setupMobileToggles();
            }

            setupEventListeners() {
                // Canvas events
                this.canvas.addEventListener('click', (e) => this.handleCanvasClick(e));
                this.canvas.addEventListener('contextmenu', (e) => this.handleContextMenu(e));
                
                // Node dragging
                this.canvasContent.addEventListener('mousedown', (e) => this.handleMouseDown(e));
                document.addEventListener('mousemove', (e) => this.handleMouseMove(e));
                document.addEventListener('mouseup', (e) => this.handleMouseUp(e));

                // Keyboard shortcuts
                document.addEventListener('keydown', (e) => this.handleKeyboard(e));

                // Window events
                window.addEventListener('resize', () => this.handleResize());
            }

            setupDragAndDrop() {
                const nodeItems = document.querySelectorAll('.node-item');
                
                nodeItems.forEach(item => {
                    item.addEventListener('dragstart', (e) => {
                        e.dataTransfer.setData('text/plain', item.dataset.nodeType);
                    });
                    
                    item.draggable = true;
                });

                this.canvas.addEventListener('dragover', (e) => {
                    e.preventDefault();
                });

                this.canvas.addEventListener('drop', (e) => {
                    e.preventDefault();
                    const nodeType = e.dataTransfer.getData('text/plain');
                    const rect = this.canvas.getBoundingClientRect();
                    const x = (e.clientX - rect.left) / this.zoom;
                    const y = (e.clientY - rect.top) / this.zoom;
                    
                    this.createNode(nodeType, x, y);
                });
            }

            setupZoomControls() {
                document.getElementById('zoomIn').addEventListener('click', () => {
                    this.setZoom(this.zoom * 1.2);
                });

                document.getElementById('zoomOut').addEventListener('click', () => {
                    this.setZoom(this.zoom * 0.8);
                });

                document.getElementById('fitToScreen').addEventListener('click', () => {
                    this.fitToScreen();
                });
            }

            setupMobileToggles() {
                document.getElementById('sidebarToggle').addEventListener('click', () => {
                    document.getElementById('sidebar').classList.toggle('open');
                });

                document.getElementById('propertiesToggle').addEventListener('click', () => {
                    document.getElementById('propertiesPanel').classList.toggle('open');
                });
            }

            createNode(type, x, y) {
                const nodeId = `${type}-${Date.now()}`;
                const nodeElement = document.createElement('div');
                nodeElement.className = 'flow-node';
                nodeElement.style.left = `${x}px`;
                nodeElement.style.top = `${y}px`;
                nodeElement.dataset.nodeId = nodeId;

                const nodeConfig = this.getNodeConfig(type);
                
                nodeElement.innerHTML = `
                    <div class="connection-point input"></div>
                    <div class="connection-point output"></div>
                    <div class="node-header">
                        <div class="node-type-icon ${type}">
                            <i class="${nodeConfig.icon}"></i>
                        </div>
                        <div class="node-title">${nodeConfig.title}</div>
                    </div>
                    <div class="node-body">
                        ${nodeConfig.body}
                    </div>
                `;

                this.canvasContent.appendChild(nodeElement);
                this.nodes.set(nodeId, {
                    element: nodeElement,
                    type: type,
                    x: x,
                    y: y,
                    config: nodeConfig
                });

                this.selectNode(nodeElement);
            }

            getNodeConfig(type) {
                const configs = {
                    start: {
                        title: 'Start Node',
                        icon: 'fas fa-play',
                        body: '<p style="font-size: 0.875rem; color: var(--gray-600); margin: 0;">Conversation starts here</p>'
                    },
                    message: {
                        title: 'Message',
                        icon: 'fas fa-comment',
                        body: '<textarea class="node-textarea" placeholder="Enter your message..."></textarea>'
                    },
                    input: {
                        title: 'User Input',
                        icon: 'fas fa-keyboard',
                        body: '<input type="text" class="node-input" placeholder="Variable name..."><textarea class="node-textarea" placeholder="Input prompt..."></textarea>'
                    },
                    condition: {
                        title: 'Condition',
                        icon: 'fas fa-code-branch',
                        body: '<input type="text" class="node-input" placeholder="Condition logic..."><select class="node-input"><option>If true</option><option>If false</option></select>'
                    },
                    api: {
                        title: 'API Call',
                        icon: 'fas fa-cloud',
                        body: '<input type="text" class="node-input" placeholder="API endpoint..."><select class="node-input"><option>GET</option><option>POST</option><option>PUT</option><option>DELETE</option></select>'
                    },
                    webhook: {
                        title: 'Webhook',
                        icon: 'fas fa-link',
                        body: '<input type="text" class="node-input" placeholder="Webhook URL..."><textarea class="node-textarea" placeholder="Payload..."></textarea>'
                    },
                    delay: {
                        title: 'Delay',
                        icon: 'fas fa-clock',
                        body: '<input type="number" class="node-input" placeholder="Seconds..." min="1" max="300"><p style="font-size: 0.75rem; color: var(--gray-500); margin: 0;">Wait before next action</p>'
                    },
                    email: {
                        title: 'Send Email',
                        icon: 'fas fa-envelope',
                        body: '<input type="email" class="node-input" placeholder="Recipient email..."><input type="text" class="node-input" placeholder="Subject..."><textarea class="node-textarea" placeholder="Email content..."></textarea>'
                    },
                    database: {
                        title: 'Database',
                        icon: 'fas fa-database',
                        body: '<select class="node-input"><option>Save Data</option><option>Load Data</option><option>Update Data</option></select><input type="text" class="node-input" placeholder="Table/Collection...">'
                    }
                };

                return configs[type] || configs.message;
            }

            selectNode(nodeElement) {
                // Deselect previous node
                if (this.selectedNode) {
                    this.selectedNode.classList.remove('selected');
                }

                // Select new node
                this.selectedNode = nodeElement;
                nodeElement.classList.add('selected');
                
                // Update properties panel
                this.updatePropertiesPanel(nodeElement);
            }

            updatePropertiesPanel(nodeElement) {
                const nodeId = nodeElement.dataset.nodeId;
                const nodeData = this.nodes.get(nodeId);
                
                if (nodeData) {
                    // Update property inputs with node data
                    const properties = document.querySelector('.properties-content');
                    properties.querySelector('.property-input').value = nodeId;
                    properties.querySelectorAll('.property-input')[1].value = nodeData.config.title;
                }
            }

            handleCanvasClick(e) {
                if (e.target === this.canvas || e.target === this.canvasContent) {
                    // Deselect all nodes
                    if (this.selectedNode) {
                        this.selectedNode.classList.remove('selected');
                        this.selectedNode = null;
                    }
                }
            }

            handleMouseDown(e) {
                const flowNode = e.target.closest('.flow-node');
                if (flowNode) {
                    this.isDragging = true;
                    this.selectNode(flowNode);
                    
                    const rect = flowNode.getBoundingClientRect();
                    const canvasRect = this.canvas.getBoundingClientRect();
                    
                    this.dragOffset = {
                        x: e.clientX - rect.left,
                        y: e.clientY - rect.top
                    };
                    
                    e.preventDefault();
                }
            }

            handleMouseMove(e) {
                if (this.isDragging && this.selectedNode) {
                    const canvasRect = this.canvas.getBoundingClientRect();
                    const x = (e.clientX - canvasRect.left - this.dragOffset.x) / this.zoom;
                    const y = (e.clientY - canvasRect.top - this.dragOffset.y) / this.zoom;
                    
                    this.selectedNode.style.left = `${Math.max(0, x)}px`;
                    this.selectedNode.style.top = `${Math.max(0, y)}px`;
                    
                    // Update node data
                    const nodeId = this.selectedNode.dataset.nodeId;
                    if (this.nodes.has(nodeId)) {
                        const nodeData = this.nodes.get(nodeId);
                        nodeData.x = x;
                        nodeData.y = y;
                    }
                }
            }

            handleMouseUp(e) {
                this.isDragging = false;
            }

            handleContextMenu(e) {
                e.preventDefault();
                const contextMenu = document.getElementById('contextMenu');
                contextMenu.style.left = `${e.clientX}px`;
                contextMenu.style.top = `${e.clientY}px`;
                contextMenu.style.display = 'block';

                // Hide context menu when clicking elsewhere
                const hideMenu = () => {
                    contextMenu.style.display = 'none';
                    document.removeEventListener('click', hideMenu);
                };
                
                setTimeout(() => {
                    document.addEventListener('click', hideMenu);
                }, 100);
            }

            handleKeyboard(e) {
                if (e.key === 'Delete' && this.selectedNode) {
                    this.deleteNode(this.selectedNode);
                }
                
                if (e.ctrlKey || e.metaKey) {
                    switch(e.key) {
                        case 's':
                            e.preventDefault();
                            this.saveProject();
                            break;
                        case 'z':
                            e.preventDefault();
                            this.undo();
                            break;
                        case 'y':
                            e.preventDefault();
                            this.redo();
                            break;
                    }
                }
            }

            deleteNode(nodeElement) {
                const nodeId = nodeElement.dataset.nodeId;
                this.nodes.delete(nodeId);
                nodeElement.remove();
                this.selectedNode = null;
            }

            setZoom(newZoom) {
                this.zoom = Math.max(0.1, Math.min(3, newZoom));
                this.canvasContent.style.transform = `scale(${this.zoom})`;
                document.getElementById('zoomLevel').textContent = `${Math.round(this.zoom * 100)}%`;
            }

            fitToScreen() {
                // Calculate bounds of all nodes
                const nodes = Array.from(this.nodes.values());
                if (nodes.length === 0) return;

                let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
                
                nodes.forEach(node => {
                    const rect = node.element.getBoundingClientRect();
                    minX = Math.min(minX, node.x);
                    minY = Math.min(minY, node.y);
                    maxX = Math.max(maxX, node.x + rect.width);
                    maxY = Math.max(maxY, node.y + rect.height);
                });

                const contentWidth = maxX - minX;
                const contentHeight = maxY - minY;
                const canvasRect = this.canvas.getBoundingClientRect();
                
                const scaleX = (canvasRect.width * 0.8) / contentWidth;
                const scaleY = (canvasRect.height * 0.8) / contentHeight;
                
                this.setZoom(Math.min(scaleX, scaleY));
            }

            loadExistingNodes() {
                // Load the default nodes that are already in the HTML
                const existingNodes = this.canvasContent.querySelectorAll('.flow-node');
                existingNodes.forEach(nodeElement => {
                    const nodeId = nodeElement.dataset.nodeId;
                    const rect = nodeElement.getBoundingClientRect();
                    const canvasRect = this.canvas.getBoundingClientRect();
                    
                    this.nodes.set(nodeId, {
                        element: nodeElement,
                        type: nodeId.split('-')[0],
                        x: parseInt(nodeElement.style.left),
                        y: parseInt(nodeElement.style.top),
                        config: this.getNodeConfig(nodeId.split('-')[0])
                    });
                });
            }

            saveProject() {
                const projectData = {
                    nodes: Array.from(this.nodes.entries()).map(([id, data]) => ({
                        id,
                        type: data.type,
                        x: data.x,
                        y: data.y,
                        config: data.config
                    })),
                    connections: Array.from(this.connections.entries())
                };

                // In a real app, this would save to a backend
                console.log('Project saved:', projectData);
                
                // Show save confirmation
                this.showNotification('Project saved successfully!', 'success');
            }

            showNotification(message, type = 'info') {
                const notification = document.createElement('div');
                notification.style.cssText = `
                    position: fixed;
                    top: 80px;
                    right: 20px;
                    background: ${type === 'success' ? 'var(--success)' : 'var(--primary)'};
                    color: white;
                    padding: 1rem 1.5rem;
                    border-radius: var(--radius-lg);
                    box-shadow: var(--shadow-xl);
                    z-index: 1001;
                    font-weight: 500;
                    animation: slideInRight 0.3s ease-out;
                `;
                
                notification.textContent = message;
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.remove();
                }, 3000);
            }

            undo() {
                // Implement undo functionality
                this.showNotification('Undo performed');
            }

            redo() {
                // Implement redo functionality  
                this.showNotification('Redo performed');
            }

            handleResize() {
                // Handle window resize events
                // Update canvas dimensions, etc.
            }
        }

        // Initialize the Visual Bot Builder
        document.addEventListener('DOMContentLoaded', () => {
            window.botBuilder = new VisualBotBuilder();
        });

        // Add CSS animation for notifications
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideInRight {
                from {
                    transform: translateX(100%);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>
